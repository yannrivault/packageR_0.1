---
  title: "queryMed package"
author: "Y. Rivault, O.Dameron and N. Le Meur"
date: "03/04/2018"
output: pdf_document
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Context

In the era of massive open-data access and big data in general, pharmaco-epidemiology and public health sciences are in need for bioinformatics tools. Researchers can now query large medical information systems such as medico-administrative databases and claim databases. They thus need batch translation of drug and disease codes to filter out known and trivial associations but also identify critical interactions for patient safety. 

Standard medical terminologies/ontologies facilitates 

Using ontologies in R has proven to be 

We propose a tool to integrate ontologies programmatically in the R environment. The queryMed package:



## Material and Methods

BIOPORTAL

SPARQL endpoints

List of accessible ontologies

## Applications



```{r load, eval=F}
library(queryMed)
```

```{r load, eval=F}
DIKB <- get_DIKB(path="/tmp",mapping="ATC")
DIKB$object <- toupper(DIKB$object)
DIKB$precipitant <- toupper(DIKB$precipitant)
clop = DIKB[DIKB$object=="CLOPIDOGREL",]
clop = as.data.table(clop)

clop2 <- clop 
clop2$atc2   <- substr(clop$atc2, 24, 30)
clop2$parent  <- substr(clop2$atc2,1, 5)
clop2$root  <- substr(clop2$atc2,1, 4)
clop2<- clop2[!is.na(clop2$atc2),]

statclop = clop2[, .N,by=list(precipitant, atc2, root)]
```


```{r igraph, eval=F}
library(RColorBrewer)
mypalette<-brewer.pal(11,"Spectral")
mypalette = cbind(mypalette, "root"=unique(statclop$root))
statclop<- merge(statclop, mypalette, by="root")

library(igraph)
g1 <- graph_from_edgelist(as.matrix(cbind("CLOPIDOGREL", statclop[,2])), directed=F) 
statclop$N[statclop$N == 1 ] <- 0
E(g1)$weight <- statclop$N         
E(g1)$width <- 1+E(g1)$weight*2
V(g1)$size <- 20
V(g1)$frame.color <- "white"
V(g1)$color <-  c("lightgrey", statclop$mypalette)
l1 <- layout_as_star(g1)
plot(g1, edge.color="grey", layout=l1)

# ancestor I
res1<-c()
res2<-c()
for (i in 1:nrow(clop2)){
temp<- get_ancestors(clop2$atc2[i], ontology="ATC", api_key="e6f2d058-f206-4ac7-a8f9-60b84c9e57dc")
res1[i] <- temp[1,2]
res2[i] <- temp[2,2]
}
clop2$anc1 <- res1 
clop2$anc2 <- res2 


statclop1 = clop2[, .N, by=list(anc1,root, parent)]
nbdrugclop1 = clop2[, length(unique(precipitant)), by=parent]

statclop2 = clop2[, .N, by=list(anc2,root)]
nbdrugclop2 = clop2[, .N, by=root]

colnames(nbdrugclop1) = c("parent","nbdrug")
colnames(nbdrugclop2) = c("root","nbdrug")
statclop1 = merge(statclop1, nbdrugclop1, by="parent")
statclop2 = merge(statclop2, nbdrugclop2, by="root")

statclop1<- merge(statclop1, mypalette, by="root")
statclop2<- merge(statclop2, mypalette, by="root")

g2 <- graph_from_edgelist(as.matrix(cbind("CLOPIDOGREL", statclop1[,3])), directed=F ) 
statclop1$N[statclop1$N == 1 ] <- 0
E(g2)$weight <- statclop1$N         
E(g2)$width <- 1+E(g2)$weight
V(g2)$size <- c(8, statclop1$nbdrug)*6
V(g2)$vertex.label.cex <-2
V(g2)$frame.color <- "white"
V(g2)$color <-  c("lightgrey", statclop1$mypalette)
#V(g2)$color <- "orange"
l2 <- layout_as_star(g2)
plot(g2, layout=l2)

# ancestor II
g3 <- graph_from_edgelist(as.matrix(cbind("CLOPIDOGREL", statclop2[,2])), directed=F) 
statclop2$N[statclop2$N == 1 ] <- 0
E(g3)$weight <- statclop2$N         
E(g3)$width <- 1+E(g3)$weight
w= c(15,20,15,20, rep(15,7))
V(g3)$size <- c(20, statclop2$nbdrug+w)
V(g3)$vertex.label.cex <-0.5
V(g3)$frame.color <- "white"
V(g3)$color <-  c("lightgrey", statclop2$mypalette)
l3 <- layout_as_star(g3)
plot(g3, vertex.label.cex= 0.8, layout=l3)

par(mfrow=c(2,2), mar=c(1,1,1,1)) 
plot(g1, vertex.label.cex= 0.8, layout=l1*0.6, main="A - Drug")
plot(g2, vertex.label.cex= 0.8, layout=l2*0.6, main="B - Ancestor I")
plot(g3, vertex.label.cex= 0.8, layout=l3*0.6, main="C - Ancestor II")
dev.off()

```


## References
\begin{thebibliography}{}

\bibitem[Kurbatova {\it et~al}., 2011]{Kurbatova11} Kurbatova, N. , Adamusiak, T., Kurnosov, P., Swertz, MA., Kapushesky, M. ontoCAT: an R package for ontology traversal and search, {\it Bioinformatics}, {\bf 27}(17), 2468â€“2470.